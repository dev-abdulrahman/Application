@model IEnumerable<Application.Entities.Models.Book>

@{
    ViewData["Title"] = "Books List";
}

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<h2>@ViewData["Title"]</h2>

<div id="itemsTableContainer">
    @await Html.PartialAsync("~/Views/Shared/PartialViews/_BooksTable.cshtml", Model)
</div>

<a class="btn btn-primary open-modal"
   data-url="@Url.Action(nameof(BooksController.Create))"
   data-title="Add"
   data-icon="bi bi-plus-circle"
   data-action-text="Add">
   Add New Book
</a>

@section Scripts {
    <script>
        $(document).on("click", ".open-modal", function () {
            var url = $(this).data("url");
            var title = $(this).data("title");
            var icon = $(this).data("icon"); // Bootstrap icon class
            var actionText = $(this).data("action-text"); // Button text

            // Load partial view into modal body
            $.get(url, function (data) {
                $("#appModalLabel").text(title);
                $("#appModalBody").html(data);
                $("#modalActionBtn").html(`<i class="${icon}"></i> ${actionText}`);

                var modal = new bootstrap.Modal(document.getElementById("appModal"));
                modal.show();
            });
        });

         $(document).on("click", "#modalActionBtn", function (e) {
            e.preventDefault(); // Stop default button behavior

            var form = $("#modalForm");
            var actionUrl = form.data("ajax-url");
             var tableRefreshUrl = form.data("table-refresh-url");

            // Re-parse client-side validation after loading partial
            $.validator.unobtrusive.parse(form);

            if (!form.valid()) {
                return; // Stop if client-side validation fails
            }
            $.ajax({
                url: actionUrl,
                type: "POST",
                data: form.serialize(),
                success: function (result) {
                    if (result.success) {
                        $("#appModal").modal("hide");
                        //Optionally refresh table
                        $.get(tableRefreshUrl, function (tableHtml) {
                            $("#itemsTableContainer").html(tableHtml);
                        });
                    } else {
                        // Replace modal body with returned HTML (validation errors)
                        $("#modalBody").html(result);
                        $.validator.unobtrusive.parse("#modalForm");
                    }
                }
            });
        });
    </script>
}